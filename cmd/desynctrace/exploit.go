package main

import (
	"fmt"
	"os"

	"github.com/spf13/cobra"
	"github.com/byteoverride/desynctrace/internal/exploits"
	"github.com/byteoverride/desynctrace/internal/vectors"
)

var (
	exploitVector string
	showPoC       bool
)

var exploitCmd = &cobra.Command{
	Use:   "exploit [url]",
	Short: "Generate exploitation payloads for a target",
	Args:  cobra.ExactArgs(1),
	Run: func(cmd *cobra.Command, args []string) {
		targetURL := args[0]
		runExploit(targetURL)
	},
}

func init() {
	rootCmd.AddCommand(exploitCmd)
	exploitCmd.Flags().StringVar(&exploitVector, "vector", "", "Specific vector to exploit (CL.TE, TE.CL, H2.CL)")
	exploitCmd.Flags().BoolVar(&showPoC, "poc", false, "Show PoC payload and curl command")
}

func runExploit(target string) {
	fmt.Printf("Generating exploit for %s\n", target)

	generator := exploits.NewExploitGenerator()

	// Determine which vector to use
	var vec vectors.SmugglingVector

	switch exploitVector {
	case "CL.TE":
		vec = vectors.NewCLTEVector()
	case "TE.CL":
		vec = vectors.NewTECLVector()
	case "H2.CL":
		vec = vectors.NewH2Vector()
	default:
		if exploitVector != "" {
			fmt.Printf("Unknown vector: %s\n", exploitVector)
			os.Exit(1)
		}
		// If no vector specified, maybe we should scan first?
		// For now, just error out or default to all?
		fmt.Println("Please specify a vector using --vector (CL.TE, TE.CL, H2.CL)")
		os.Exit(1)
	}

	poc, err := generator.GeneratePoC(target, vec)
	if err != nil {
		fmt.Printf("Error generating PoC: %v\n", err)
		os.Exit(1)
	}

	fmt.Println("==================================================")
	fmt.Printf("Exploit: %s\n", poc.Name)
	fmt.Printf("Description: %s\n", poc.Description)
	fmt.Println("==================================================")

	if showPoC {
		fmt.Println("RAW PAYLOAD:")
		fmt.Println(poc.RawPayload)
		fmt.Println("--------------------------------------------------")
		fmt.Println("CURL COMMAND (Approximate):")
		fmt.Println(poc.CurlCommand)
	} else {
		// Maybe execute it? The prompt said "desynctrace exploit ... --poc" so implies generating PoC.
		// If not --poc, maybe it runs it?
		// "Exploitation Module ... Request smuggling PoCs ... XSS via poisoning"
		// For safety, let's just print the PoC for now unless we add an --execute flag.
		fmt.Println("Use --poc to see the payload.")
	}
}
